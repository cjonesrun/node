#!/usr/bin/env node
var log4js = require('log4js');
var cluster = require('express-cluster');

// make log dir if missing
try {
  require('fs').mkdirSync('./log');
} catch (e) {
  if (e.code != 'EEXIST') {
    console.error("Could not mkdir ./log. error: ", e);
    process.exit(1);
  }
}

// init logging
log4js.configure('./config/log4js.json');
var log = log4js.getLogger("app");

cluster(function() {
  var app = require('../app');
  console.log(process.env.PORT);
  app.set('port', process.env.PORT || 8080);

  var server = app.listen(app.get('port'), function() {
    log.info('listening on port ', server.address().port, " with pid ", process.pid );
  });
}, {count: 4});
